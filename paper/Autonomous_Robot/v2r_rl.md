# Virtual to Real Reinforcement Learning for Autonomous Driving
自动驾驶的虚拟到现实强化学习 https://arxiv.org/abs/1704.03952

## Abstract
Reinforcement learning is considered as a promising direction for driving policy learning. However, training autonomous driving vehicle with reinforcement learning in real environment involves non-affordable trial-and-error. It is more desirable to first train in a virtual environment and then transfer to the real environment. In this paper, we propose a novel realistic translation network to make model trained in virtual environment be workable in real world. The proposed network can convert non-realistic virtual image input into a realistic one with similar scene structure. Given realistic frames as input, driving policy trained by reinforcement learning can nicely adapt to real world driving. Experiments show that our proposed virtual to real (VR) reinforcement learning (RL) works pretty well. To our knowledge, this is the first successful case of driving policy trained by reinforcement learning that can adapt to real world driving data.

强化学习被认为是推动策略学习的一个有前途的方向。然而，在真实环境中训练具有强化学习的自动驾驶车辆涉及不可承受的试错。更期望的是首先在虚拟环境中训练，然后迁移到真实环境。在本文中，我们提出了一种新的现实主义翻译网络，以使在虚拟环境中训练的模型在现实世界中可行。所提出的网络可以将非真实的虚拟图像输入转换为具有相似场景结构的真实图像输入。给定现实的框架作为输入，通过强化学习训练的驾驶策略可以很好地适应现实世界的驾驶。实验表明，我们提出的虚拟到现实(VR)强化学习(RL)非常有效。据我们所知，这是第一个通过强化学习训练的驾驶策略成功案例，该强化学习能够适应真实世界的驾驶数据。

## Introduction
Autonomous driving aims to make a vehicle sense its environment and navigate without human input. To achieve this goal, the most important task is to learn the driving policy that automatically outputs control signals for steering wheel, throttle, brake, etc., based on observed surroundings. The straight-forward idea is end-to-end supervised learning [3, 4], which trains a neural network model mapping visual input directly to action output, and the training data is labeled image-action pairs. However, supervised approach usually requires large amount of data to train a model [31] that can generalize to different environments. Obtaining such amount of data is time consuming and requires significant human involvement. By contrast, reinforcement learning learns by a trial-and-error fashion, and does not require explicit supervision from human. Recently, reinforcement learning has been considered as a promising technique to learn driving policy due to its expertise in action planing [15, 23, 25].

自动驾驶的目的是让车辆感知环境并在无需人工输入的情况下进行导航。为了实现这一目标，最重要的任务是学习驾驶策略，该策略根据观察到的环境自动输出方向盘、油门、制动器等的控制信号。直接的想法是端到端监督学习[3，4]，它训练将视觉输入直接映射到动作输出的神经网络模型，并且训练数据被标记为图像-动作对。然而，有监督的方法通常需要大量数据来训练可以推广到不同环境的模型[31]。获取如此数量的数据非常耗时，需要大量的人力参与。相比之下，强化学习以试错的方式学习，不需要人类的明确监督。最近，强化学习由于其在行动规划方面的专业知识，被认为是学习驾驶策略的一种有前途的技术[15，23，25]。

However, reinforcement learning requires agents to interact with environments, and undesirable driving actions would happen. Training autonomous driving cars in real world will cause damages to vehicles and the surroundings. Therefore, most of current research in autonomous driving with reinforcement learning focus on simulations [15, 18, 25] rather than training in real world. While an agent trained with reinforcement learning achieves near human-level driving performance in virtual world [18], it may not be applicable to real world driving environment, since the visual appearance of virtual simulation environment is different from that of real world driving scene.

然而，强化学习需要智能体与环境交互，并且会发生不期望的驾驶行为。在现实世界中训练自动驾驶汽车会对车辆和周围环境造成损害。因此，当前大多数具有强化学习的自动驾驶研究都侧重于模拟[15，18，25]，而不是现实世界中的训练。虽然通过强化学习训练的智能体在虚拟世界中实现了接近人类水平的驾驶性能[18]，但它可能不适用于真实世界驾驶环境，因为虚拟仿真环境的视觉外观与真实世界驾驶场景的视觉外观不同。

Figure 1: Framework for virtual to real reinforcement learning for autonomous driving. Virtual images rendered by a simulator (environment) are first segmented to scene parsing representation and then translated to synthetic realistic images by the proposed image translation network (VISRI). Agent observes synthetic realistic images and takes actions. Environment will give reward to the agent. Since the agent is trained using realistic images that are visually similar to real world scenes, it can nicely adapt to real world driving. 
图1：自动驾驶的虚拟到真实强化学习框架。由模拟器(环境)渲染的虚拟图像首先被分割成场景解析表示，然后通过所提出的图像翻译网络(VISRI)被翻译成合成的真实图像。智能体人观察合成的真实图像并采取行动。环境会给智能体人奖励。由于智能体使用视觉上与真实世界场景相似的真实图像进行训练，因此它可以很好地适应真实世界的驾驶。

While virtual driving scenes have a different visual appearance compared with real driving scenes, they share similar scene parsing structure. For example, virtual and real driving scenes may all have roads, trees, buildings, etc., though the textures may be significantly different. Therefore, it is reasonable that by translating virtual images to their realistic counterparts, we can obtain a simulation environment that looks very similar to the real world in terms of both scene parsing structure and object appearance. Recently, generative adversarial network (GAN) [9] has drawn a lot of attention in image generation. The work by [11] proposed an image-to-image translation network that can translate images from one domain to another using paired data from both domains. However, it is very hard to find paired virtual-real world images for driving, making it difficult to apply this method to our case of translating virtual driving images to realistic ones.

虽然与真实驾驶场景相比，虚拟驾驶场景具有不同的视觉外观，但它们共享相似的场景解析结构。例如，虚拟和真实的驾驶场景可能都有道路、树木、建筑物等，尽管纹理可能有很大不同。因此，通过将虚拟图像转换为它们的真实对应物，我们可以获得在场景解析结构和对象外观方面看起来与真实世界非常相似的模拟环境，这是合理的。最近，生成对抗网络(GAN)[9]在图像生成中引起了大量关注。[11]的工作提出了一种图像到图像转换网络，该网络可以使用来自两个域的成对数据将图像从一个域转换到另一个域。然而，很难找到用于驾驶的成对虚拟现实世界图像，这使得很难将这种方法应用于我们将虚拟驾驶图像转换为现实驾驶图像的情况。

In this paper, we propose a realistic translation network to help train self-driving car entirely in virtual world that can adapt to real world driving environment. Our proposed framework (shown in Figure 1) converts virtual images rendered by the simulator to a realistic one and train the reinforcement learning agent with the synthesized realistic images. Though virtual and realistic images have a different visual appearance, they share a common scene parsing representation (segmentation map of roads, vehicles etc.). Therefore, we can translate virtual images to realistic images by using scene parsing representation as the interim. This insight is similar to natural language translation, where semantic meaning is the interim between different languages. Specifically, our realistic translation network includes two modules. The first one is a virtual-to-parsing or virtual-to-segmentation module that produces a scene parsing representation of input virtual image. The second one is a parsing-to-real network that translates scene parsing representations into realistic images. With realistic translation network, reinforcement learning model learnt on the realistic driving data can nicely apply to real world driving.

在本文中，我们提出了一个现实的翻译网络，以帮助在虚拟世界中完全训练自动驾驶汽车，从而适应真实世界的驾驶环境。我们提出的框架(如图1所示)将模拟器渲染的虚拟图像转换为真实图像，并用合成的真实图像训练强化学习智能体。尽管虚拟图像和真实图像具有不同的视觉外观，但它们共享一个共同的场景解析表示(道路、车辆等的分割图)。因此，我们可以通过使用场景解析表示作为过渡将虚拟图像转换为真实图像。这种理解类似于自然语言翻译，其中语义是不同语言之间的过渡。具体来说，我们的现实主义翻译网络包括两个模块。第一个是虚拟到解析或虚拟到分割模块，其产生输入虚拟图像的场景解析表示。第二种是解析到真实网络，将场景解析表示转换为真实图像。通过真实的翻译网络，基于真实驾驶数据学习的强化学习模型可以很好地应用于真实世界的驾驶。

To demonstrate the effectiveness of our method, we trained our reinforcement learning model by using the realistic translation network to filter virtual images to synthetic realistic images and feed these realistic images as state inputs. We further compared with supervised learning and other reinforcement learning approaches that use domain randomization [22]. Our experiments illustrate that a reinforcement learning model trained with translated realistic images has better performance than reinforcement learning model trained with only virtual input and virtual to real reinforcement learning with domain randomization. 

为了证明我们方法的有效性，我们通过使用真实翻译网络来训练我们的强化学习模型，以将虚拟图像过滤为合成真实图像，并将这些真实图像作为状态输入。我们进一步比较了使用领域随机化的监督学习和其他强化学习方法[22]。我们的实验表明，使用翻译的真实图像训练的强化学习模型比仅使用虚拟输入和使用域随机化的虚拟到真实强化学习训练的强化模型具有更好的性能。

## 1 Related Work
### Supervised Learning for Autonomous Driving. 
Supervised learning methods are obviously straightforward ways to train autonomous vehicles. ALVINN [19] provides an early example of using neural network for autonomous driving. Their model is simple and direct, which maps image inputs to action predictions with a shallow network. Powered by deep learning especially a convolutional neural network, NVIDIA [3] recently provides an attempt to leverage driving video data for simple lane following task. Another work by [4] learns a mapping between input images to a number of key perception indicators, which are closely related to the affordance of a driving state. However, the learned affordance must be associated with actions through hand-engineered rules. These supervised methods work relatively well in simple tasks such as lane-following and driving on a highway. On the other hand, imitation learning can also be regarded as supervised learning approach [32], where the agent observes the demonstrations performed by some experts and learns to imitate the actions of the experts. However, an intrinsic shortcoming of imitation learning is that it has the covariate shift problem [20] and can not generalize very well to scenes never experienced before.

自动驾驶的监督学习。监督学习方法显然是训练自动驾驶汽车的直接方法。ALVINN[19]提供了将神经网络用于自动驾驶的早期样本。他们的模型简单直接，通过浅层网络将图像输入映射到动作预测。借助于深度学习，特别是卷积神经网络，NVIDIA[3]最近提供了一种尝试，将驾驶视频数据用于简单的车道跟随任务。[4]的另一项工作学习了输入图像与许多关键感知指标之间的映射，这些指标与驾驶状态的可承受性密切相关。然而，学习到的启示必须通过手工设计的规则与行动相关联。这些受监督的方法在简单的任务中相对有效，例如车道跟随和高速公路驾驶。另一方面，模仿学习也可以被视为监督学习方法[32]，其中智能体人观察一些专家进行的演示，并学习模仿专家的行为。然而，模仿学习的一个内在缺点是它具有协变移位问题[20]，并且不能很好地推广到以前从未经历过的场景。

### Reinforcement Learning for Autonomous Driving. 
Reinforcement learning has been applied to a wide variety of robotics related tasks, such as computer games [17], robot locomotion [8, 12], and autonomous driving [1, 25]. One of the challenges in practical realworld applications of reinforcement learning is the high-dimensionality of state space as well as the non-trivial large action range. Developing an optimal policy over such highcomplexity space is time consuming. Recent work in deep reinforcement learning has made great progress in learning in a high dimensional space with the power of deep neural networks [13, 15, 17, 18, 24]. However, both deep Q-learning method [17] and policy gradient method [15] require the agent to interact with the environment to get reward and feedback. However, it is unrealistic to train autonomous vehicle with reinforcement learning in a real world environment since the car may hurt its surroundings once it takes a wrong action.

自动驾驶强化学习。强化学习已应用于各种机器人相关任务，如计算机游戏[17]、机器人运动[8，12]和自动驾驶[1,25]。强化学习在实际应用中的挑战之一是状态空间的高维度以及非平凡的大动作范围。在如此高复杂度的空间上开发最佳策略是非常耗时的。最近在深度强化学习方面的工作利用深度神经网络的力量在高维空间学习方面取得了巨大进展[13，15，17，18，24]。然而，深度Q学习方法[17]和策略梯度方法[15]都要求智能体与环境交互以获得奖励和反馈。然而，在真实世界环境中用强化学习训练自动驾驶汽车是不现实的，因为一旦汽车采取错误的行动，它可能会伤害周围环境。

### Reinforcement Learning in the Wild. 
Performing reinforcement learning with a car driving simulator and transferring learned models to the real environment could enable faster, lower-cost training, and it is much safer than training with a real car. However, real-world driving challenge usually spans a diverse range, and it is often significantly different from the training environment in a car driving simulator in terms of their visual appearance. Models trained purely on virtual data do not generalize well to real images [6, 27]. Recent progress of transfer and domain adaptation learning in robotics provides examples of simulation-toreal reinforcement training [10, 21, 26]. These models either first train a model in virtual environment and then fine-tune in the real environment [21], or learn an alignment between virtual images and real images by finding representations that are shared between the two domains [27], or use randomized rendered virtual environments to train and then test in real environment [22, 26]. The work of [21] proposes to use progressive network to transfer network weights from model trained on virtual data to the real environment and then finetune the model in a real setting. The training time in real environment has been greatly reduced by first training in a virtual environment. However, it is still necessary to train the agent in the real environment, thus it does not solve the critical problem of avoiding risky trial-and-error in real world. Methods that try to learn an alignment between virtual images and real images could fail to generalize to more complex scenarios, especially when it is hard to find a good alignment between virtual images and real images. As a more recent work, [22] proposed a new framework for training a reinforcement learning agent with only a virtual environment. Their work proved the possibility of performing collisionfree flight in real world with training in 3D CAD model simulator. However, as mentioned in the conclusion of their paper [22], the manual engineering work to design suitable training environments is nontrivial, and it is more reasonable to attain better results by combining simulated training with some real data, though it is unclear from their paper how to combine real data with simulated training.

野外强化学习。使用汽车驾驶模拟器进行强化学习，并将学习到的模型迁移到真实环境中，可以实现更快、更低成本的训练，而且比使用真实汽车进行训练安全得多。然而，现实世界中的驾驶挑战通常涉及不同的范围，在视觉外观方面，它通常与汽车驾驶模拟器中的训练环境有显著不同。纯基于虚拟数据训练的模型不能很好地推广到真实图像[6，27]。机器人技术中迁移和领域自适应学习的最新进展提供了模拟强化训练的样本[10，21，26]。这些模型要么首先在虚拟环境中训练模型，然后在真实环境中进行微调[21]，要么通过找到两个域之间共享的表示来学习虚拟图像和真实图像之间的对齐[27]，要么使用随机渲染的虚拟环境来训练，然后在现实环境中进行测试[22，26]。[21]的工作提出使用渐进网络将网络权重从基于虚拟数据训练的模型传递到真实环境，然后在真实环境中对模型进行微调。通过在虚拟环境中进行首次训练，在真实环境中的训练时间大大减少。然而，仍然需要在真实环境中训练智能体，因此它不能解决避免现实世界中风险试错的关键问题。尝试学习虚拟图像和真实图像之间的对齐的方法可能无法推广到更复杂的场景，特别是当很难找到虚拟图像和实际图像之间的良好对齐时。作为最近的一项工作，[22]提出了一种新的框架，用于仅在虚拟环境中训练强化学习智能体。他们的工作证明了在3D CAD模型模拟器中进行训练，在现实世界中实现无碰撞飞行的可能性。然而，正如他们的论文[22]的结论中所提到的，设计合适的训练环境的人工工程工作非常重要，通过将模拟训练与一些真实数据相结合来获得更好的结果更为合理，尽管他们的论文中不清楚如何将真实数据与模拟训练相结合。

### Image Synthesis and Image Translation. 
Image translation aims to predict image in some specific modality, given an image from another modality. This can be treated as a generic method as it predicts pixels from pixels. Recently, the community has made significant progress in generative approaches, mostly based on generative adversarial networks [9]. To name a few, the work of [29] explored the use of VAE-GAN [14] in generating 3D voxel models, and the work of [28] proposed a cascade GAN to generate natural images by structure and style. More recently, the work of [11] developed a general and simple framework for image-to-image translation which can handle various pixel level generative tasks like semantic segmentation, colorization, rendering edge maps, etc.

图像合成和图像翻译。图像翻译的目的是预测某一特定模态的图像，给定另一模态的图像。这可以被视为一种通用方法，因为它从像素中预测像素。最近，社区在生成方法方面取得了重大进展，主要基于生成对抗网络[9]。举几个例子，[29]的工作探索了VAE-GAN[14]在生成3D体素模型中的应用，[28]的工作提出了级联GAN，以根据结构和样式生成自然图像。最近，[11]的工作为图像到图像的翻译开发了一个通用而简单的框架，可以处理各种像素级生成任务，如语义分割、着色、渲染边缘图等。

### Scene Parsing. 
One part of our network is the semantic image segmentation network. There are already many great works in the field of semantic image segmentation. Many of them are based on deep convolutional neural network or fully convolutional neural network [16]. In this paper, we use the SegNet for image segmentation, the structure of the network is revealed in [2], which is composed of two main parts. The first part is an encoder, which consists of Convolutional, Batch Normalization, ReLU and max pooling layers. The second part is a decoder, which replaces the pooling layers with upsampling layers. 

场景分析。我们网络的一部分是语义图像分割网络。在语义图像分割领域已经有许多伟大的工作。其中许多基于深度卷积神经网络或完全卷积神经网络[16]。在本文中，我们使用SegNet进行图像分割，[2]揭示了网络的结构，它由两个主要部分组成。第一部分是编码器，由卷积、批归一化、ReLU和最大池化层组成。第二部分是解码器，它用上采样层替换池化层。

## 2 Reinforcement Learning in the Wild
We aim to successfully apply a driving model trained entirely in virtual environment to realworld driving challenges. One of the major gaps is that what the agent observes are frames rendered by a simulator, which are different from real world frames in terms of their appearance. Therefore, we proposed a realistic translation network to convert virtual frames to realistic ones. Inspired by the work of image-to-image translation network [11], our network includes two modules, namely virtual-to-parsing and parsing-to-realistic network. The first one maps virtual frame to scene parsing image. The second one translates scene parsing to realistic frame with similar scene structure as the input virtual frame. These two modules generate realistic frames that maintain the scene parsing structure of input virtual frames. The architecture of realistic translation network is illustrated on Figure 1. Finally, we train a self-driving agent using reinforcement learning method on realistic frames obtained by realistic translation network. The approach we adopt is developed by [18], where they use the asynchronous actor-critic reinforcement learning algorithm to train a self-driving vehicle in the car racing simulator TORCS [30]. In this section, we will first present proposed realistic translation network and then discuss how to train driving agent under a reinforcement learning framework.

Figure 2: Example image segmentation for both virtual world images (Left 1 and Left 2) and real world images (Right 1 and Right 2). 

## 2.1 Realistic Translation Network
As there is no paired virtual and real world image, a direct mapping from virtual world image to real world image using [11] would be awkward. However, as these two types of images both express driving scene, we can translate them by using scene parsing representation. Inspired by [11], our realistic translation network is composed of two image translation networks, where the first image translation network translates virtual images to their segmentations, and the second image translation network translates segmented images to their real world counterparts.

The image-to-image translation network proposed by [11] is basically a conditional GAN. The difference between traditional GANs and conditional GANs is that GANs learn a mapping from random noise vector z to output image s : G : z → s, while conditional GANs take in both an image x and a noise vector z, and generate another image s : G : {x,z} → s, where s is usually in a different domain compared with x (For example, translate images to their segmentations).

The objective of a conditional GAN can be expressed as, 

LcGAN(G,D) =Ex,s∼pdata(x,s)[logD(x,s)] +Ex∼pdata(x),z∼pz(z)[log(1−D(x,G(x,z)))], (1) 

where G is the generator that tries to minimize this objective and D is the adversarial discriminator that acts against G to maximize this objective. In other words, G∗ = argminG maxD LcGAN(G,D). In order to suppress blurring, a L1 loss regularization term is added, which can be expressed as,

LL1(G) = Ex,s∼pdata(x,s),z∼pz(z)[k s−G(x,z)k 1]. (2)

Therefore, the overall objective for the image-to-image translation network is,

G∗ = argmin G max D LcGAN(G,D) +λLL1(G), (3) 

where λ is the weight of regularization.

Our network consists of two image-to-image translation networks, both networks use the same loss function as equation 3. The first network translates virtual images x to their segmentations s : G1 : {x,z1} → s, and the second network translates segmented images s into their realistic counterparts y : G2 : {s,z2} → y, where z1,z2 are noise terms to avoid deterministic outputs. As for GAN neural network structures, we use the same generator and discriminator architectures as used in [11].

## 2.2 Reinforcement Learning for Training a Self-Driving Vehicle
We use a conventional RL solver Asynchronous Advantage Actor-Critic (A3C)[18] to train the self driving vehicle, which has performed well on various machine learning tasks. A3C algorithm is a fundamental Actor-Critic algorithm that combines several classic reinforcement learning algorithms with the idea of asynchronous parallel threads. Multiple threads run at the same time with unrelated copies of the environment, generating their own sequences of training samples. Those actors-learners proceed as though they are exploring different parts of the unknown space. For one thread, parameters are synchronized before an iteration of learning and updated after finishing it. The details of A3C algorithm implementation can be found in [18].

In order to encourage the agent to drive faster and avoid collisions, we define the reward function as 

rt =  (vt · cosα −dist(t) center)· β no collision, γ collision, (4) 

where vt is the speed (in m/s) of the agent at time step t, α is the angle (in rad) between the agent’s speed and the tangent line of the track, and dist(t) center is the distance between the center of the agent and the middle of the track. β, γ are constants and are determined at the beginning of training. We take β = 0.006, γ = −0.025 in our training. 

## 3 Experiments
We performed two sets of experiments to compare the performance of our method and other reinforcement learning methods as well as supervised learning methods. The first sets of experiments involves virtual to real reinforcement learning on real world driving data. The second sets of experiments involves transfer learning in different virtual driving environments. The virtual simulator used in our experiments is TORCS[30].

Figure 3: Reinforcement learning network architecture. The network is an end-to-end network mapping state representations to action probability outputs.

Figure 4: Examples of Virtual to Real Image Translation. Odd columns are virtual images captured from TORCS. Even columns are synthetic real world images corresponding to virtual images on the left.

## 3.1 Virtual to Real RL on Real World Driving Data
In this experiment, we trained our proposed reinforcement learning model with realistic translation network. We first trained the virtual to real image translation network, and then used the trained network to filter virtual images in simulator to realistic images. These realistic images were then feed into A3C to train a driving policy. Finally, the trained policy was tested on a real world driving data to evaluate its steering angle prediction accuracy.

For comparison, we also trained a supervised learning model to predict steering angles for every test driving video frame. The model is a deep neural network that has the same architecture design as the policy network in our reinforcement learning model. The input of the network is a sequence of four consecutive frames, the output of the network is the action probability vector, and elements in the vector represent the probability of going straight, turning left and turning right. The training data for the supervised learning model is different from the testing data that is used to evaluate model performance. In addition, another baseline reinforcement learning model (B-RL) is also trained. The only difference between B-RL and our method is that the virtual world images were directly taken by the agent as state inputs. This baseline RL is also tested on the same real world driving data.

Dataset. The real world driving video data are from [5], which is collected in a sunny day with detailed steering angle annotations per frame. There are in total around 45k images in this dataset, of which 15k were selected for training the supervised learning model, and another 15k were selected and held out for testing. To train our realistic translation network, we collected virtual images and their segmentations from the Aalborg environment in TORCS. A total of 1673 images were collected which covers the entire driving cycle of Aalborg environment.


Figure 5: Transfer learning between different environments. Oracle was trained in Cgtrack2 and tested in Cgtrack2, so its performance is the best. Our model works better than the domain randomization RL method. Domain randomization method requires training in multiple virtual environments, which imposes significant manual engineering work. 

Scene Segmentation. We used the image semantic segmentation network design of [2] and their trained segmentation network on the CityScape image segmentation dataset [7] to segment 45k real world driving images from [5]. The network was trained on the CityScape dataset with 11 classes and was trained with 30000 iterations.

Image Translation Network Training. We trained both virtual-to-parsing and parsingto-real network using the collected virtual-segmentation image pairs and segmentation-real image pairs. The translation networks are of a encoder-decoder fashion as shown in figure 1. In the image translation network, we used U-Net architecture with skip connection to connect two separate layers from encoder and decoder respectively, which have the same output feature map shape. The input size of the generator is 256×256. Each convolutional layer has a kernel size of 4×4 and striding size of 2. LeakyReLU is applied after every convolutional layer with a slope of 0.2 and ReLU is applied after every deconvolutional layer. In addition, batch normalization layer is applied after every convolutional and deconvolutional layer. The final output of the encoder is connected with a convolutional layer which yields output of shape 3 × 256 × 256 followed by Tanh. We used all 1673 virtual-segmentation image pairs to train a virtual to segmentation network. As there are redundancies in the 45k real images, we selected 1762 images and their segmentations from the 45k images to train a parsing-to-real image translation network. To train the image translation models, we used the Adam optimizer with an initial learning rate of 0.0002, momentum of 0.5, batchsize of 16, and 200 iterations until convergence.

Reinforcement Training. The RL network structure used in our training is similar to that of [18] where the actor network is a 4-layer convolutional network (shown in figure 3) with ReLU activation functions in-between. The network takes in 4 consecutive RGB frames as state input and output 9 discrete actions which corresponds to “go straight with acceleration”, “go left with acceleration”, “go right with acceleration”, “go straight and brake”, “go left and brake”, “go right and brake”, “go straight”, “go left”, and “go right”. We trained the reinforcement learning agent with 12 asynchronous threads, and with the RMSProp optimizer at an initial learning rate of 0.01, γ = 0.9, and ε = 0.1.

Evaluation. The real world driving dataset [5] provides the steering angle annotations per frame. However, the actions performed in the TORCS virtual environment only contain "going left", "going right", and "going straight" or their combinations with "acceleration" or "brake". Therefore, we define a label mapping strategy to translate steering angle labels to action labels in the virtual simulator. We relate steering angle in (−10,10) to action "going straight" (since small steering angle is not able to result in a distinct turning in a short time), steering angle less than −10 to action "going left" and steering angle more than 10 to action "going right". By comparing output actions generated from our method with ground truth, we can obtain the accuracy of driving action prediction.

## 3.2 Transfer Learning in Virtual Driving Environments
We further performed another sets of experiments and obtained results of transfer learning between different virtual driving environments. In this experiments, we trained three reinforcement learning agents. The first agent was trained with standard A3C in the Cg−track2 environment in TORCS, and evaluated its performance frequently in the same environments. It is reasonable to expect the performance of this agent to be the best, so we call it "Oracle". The second agent was trained with our proposed reinforcement learning method with realistic translation network. However, it was trained in E-track1 environment in TORCS and then evaluated in Cg-track2. It is necessary to note that the visual appearance of E-track1 is different from that of Cg-track2. The third agent was trained with domain randomization method similar to that of [22], where the agent was trained with 10 different virtual environments and evaluated in Cg-track2. For training with our methods, we obtain 15k segmented images for both E-track1 and Cg-track2 to train virtual-to-parsing and parsing-to-real image translation networks. The image translation training details and reinforcement learning details are the same as that of section 3.1. 

## 4 Results
Image Segmentation Results. We used image segmentation model trained on the cityscape [7] dataset to segment both virtual and real images. Examples are shown in figure 2. As shown in the figure, although the original virtual image and real image look quite different, their scene parsing results are very similar. Therefore, it is reasonable to use scene parsing as the interim to connect virtual images and real images.

Qualitative Result of Realistic Translation Network. Figure 4 shows some representative results of our image translation network. The odd columns are virtual images in TORCS, and the even columns are translated realistic images. The images in the virtual environment appears to be darker than the translated images, as the real images used to train the translation network is captured in a sunny day. Therefore, our model succeed to synthesize realistic images of similar appearance with the original ground truth real images.

Reinforcement Training Results. The results for virtual to real reinforcement learning on real world driving data are shown in table 1. Results show that our proposed method has a better overall performance than the baseline method (B-RL), where the reinforcement training agent is trained in a virtual environment without seeing any real data. The supervised method (SV) has the best overall performance, however, was trained with large amounts of supervised labeled data. 


Table 1: Action prediction accuracy for the three methods.

Accuracy | Ours | B-RL | SV
--- | --- | --- | ---
Dataset in [5] | 43.40% | 28.33% | 53.60%

The result for transfer learning in different virtual environments is shown in figure 5. Obviously, standard A3C (Oracle) trained and tested in the same environment gets the best performance. However, our model performs better than the domain randomization method, which requires training in multiple environments to generalize. As mentioned in [22], domain randomization requires lots of engineering work to make it generalize. Our model succeeds by observing translated images from E-track1 to Cg-track2, which means the model already gets training in an environment that looks very similar to the test environment (Cgtrack2), thus the performance is improved. 

## 5 Conclusion
We proved through experiments that by using synthetic real images as training data in reinforcement learning, the agent generalizess better in a real environment than pure training with virtual data or training with domain randomization. The next step would be to design a better image-to-image translation network and a better reinforcement learning framework to surpass the performance of supervised learning.

Thanks to the bridge of scene parsing, virtual images can be translated into realistic images which maintain their scene structure. The learnt reinforcement learning model on realistic frames can be easily applied to real-world environment. We also notice that the translation results of a segmentation map are not unique. For example, segmentation map indicates a car, but it does not assign which color of that car should be. Therefore, one of our future work is to make parsing-to-realistic network output various possible appearances (e.g. color, texture). In this way, bias in reinforcement learning training would be largely reduced.

We provide the first example of training a self-driving vehicle using reinforcement learning algorithm by interacting with a synthesized real environment with our proposed imageto-segmentation -to-image framework. We show that by using our method for RL training, it is possible to obtain a self driving vehicle that can be placed in the real world.

## References
1. Pieter Abbeel, Adam Coates, Morgan Quigley, and Andrew Y Ng. An application of reinforcement learning to aerobatic helicopter flight. Advances in neural information processing systems, 19:1, 2007.
2. Vijay Badrinarayanan, Alex Kendall, and Roberto Cipolla. Segnet: A deep convolutional encoder-decoder architecture for image segmentation. arXiv preprint arXiv:1511.00561, 2015.
3. Mariusz Bojarski, Davide Del Testa, Daniel Dworakowski, Bernhard Firner, Beat Flepp, Prasoon Goyal, Lawrence D. Jackel, Mathew Monfort, Urs Muller, Jiakai Zhang, Xin Zhang, Jake Zhao, and Karol Zieba. End to end learning for self-driving cars. CoRR, abs/1604.07316, 2016. URL http://arxiv.org/abs/1604.07316.
4. Chenyi Chen, Ari Seff, Alain L. Kornhauser, and Jianxiong Xiao. Deepdriving: Learning affordance for direct perception in autonomous driving. CoRR, abs/1505.00256, 2015. URL http://arxiv.org/abs/1505.00256.
5. Sully Chen. Autopilot-tensorflow, 2016. URL https://github.com/SullyChen/Autopilot-TensorFlow.
6. Paul Christiano, Zain Shah, Igor Mordatch, Jonas Schneider, Trevor Blackwell, Joshua Tobin, Pieter Abbeel, and Wojciech Zaremba. Transfer from simulation to real world through learning deep inverse dynamics model. arXiv preprint arXiv:1610.03518, 2016.
7. Marius Cordts, Mohamed Omran, Sebastian Ramos, Timo Rehfeld, Markus Enzweiler, Rodrigo Benenson, Uwe Franke, Stefan Roth, and Bernt Schiele. The cityscapes dataset for semantic urban scene understanding. CoRR, abs/1604.01685, 2016. URL http://arxiv.org/abs/1604.01685.
8. Gen Endo, Jun Morimoto, Takamitsu Matsubara, Jun Nakanishi, and Gordon Cheng. Learning cpg-based biped locomotion with a policy gradient method: Application to a humanoid robot. The International Journal of Robotics Research, 27(2):213–228, 2008.
9. Ian Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-Farley, Sherjil Ozair, Aaron Courville, and Yoshua Bengio. Generative adversarial nets. In Z. Ghahramani, M. Welling, C. Cortes, N. D. Lawrence, and K. Q. Weinberger, editors, Advances in Neural Information Processing Systems 27, pages 2672–2680. Curran Associates, Inc., 2014. URL http://papers.nips.cc/paper/5423-generative-adversarial-nets.pdf.
10. Abhishek Gupta, Coline Devin, YuXuan Liu, Pieter Abbeel, and Sergey Levine. Learning invariant feature spaces to transfer skills with reinforcement learning. arXiv preprint arXiv:1703.02949, 2017.
11. Phillip Isola, Jun-Yan Zhu, Tinghui Zhou, and Alexei A. Efros. Image-to-image translation with conditional adversarial networks. CoRR, abs/1611.07004, 2016. URL http://arxiv.org/abs/1611.07004. 
12. Nate Kohl and Peter Stone. Policy gradient reinforcement learning for fast quadrupedal locomotion. In Robotics and Automation, 2004. Proceedings. ICRA’04. 2004 IEEE International Conference on, volume 3, pages 2619–2624. IEEE, 2004.
13. Jan Koutník, Giuseppe Cuccu, Jürgen Schmidhuber, and Faustino Gomez. Evolving large-scale neural networks for vision-based reinforcement learning. In Proceedings of the 15th annual conference on Genetic and evolutionary computation, pages 1061–1068. ACM, 2013.
14. Anders Boesen Lindbo Larsen, Søren Kaae Sønderby, and Ole Winther. Autoencoding beyond pixels using a learned similarity metric. CoRR, abs/1512.09300, 2015. URL http://arxiv.org/abs/1512.09300.
15. Timothy P Lillicrap, Jonathan J Hunt, Alexander Pritzel, Nicolas Heess, Tom Erez, Yuval Tassa, David Silver, and Daan Wierstra. Continuous control with deep reinforcement learning. arXiv preprint arXiv:1509.02971, 2015.
16. Jonathan Long, Evan Shelhamer, and Trevor Darrell. Fully convolutional networks for semantic segmentation. In The IEEE Conference on Computer Vision and Pattern Recognition (CVPR), June 2015.
17. Volodymyr Mnih, Koray Kavukcuoglu, David Silver, Andrei A Rusu, Joel Veness, Marc G Bellemare, Alex Graves, Martin Riedmiller, Andreas K Fidjeland, Georg Ostrovski, et al. Human-level control through deep reinforcement learning. Nature, 518 (7540):529–533, 2015.
18. Volodymyr Mnih, Adrià Puigdomènech Badia, Mehdi Mirza, Alex Graves, Timothy P. Lillicrap, Tim Harley, David Silver, and Koray Kavukcuoglu. Asynchronous methods for deep reinforcement learning. CoRR, abs/1602.01783, 2016. URL http: //arxiv.org/abs/1602.01783.
19. Dean A Pomerleau. Alvinn, an autonomous land vehicle in a neural network. Technical report, Carnegie Mellon University, Computer Science Department, 1989.
20. Stéphane Ross and Drew Bagnell. Efficient reductions for imitation learning. In AISTATS, volume 3, pages 3–5, 2010.
21. Andrei A. Rusu, Matej Vecerik, Thomas Rothörl, Nicolas Heess, Razvan Pascanu, and Raia Hadsell. Sim-to-real robot learning from pixels with progressive nets. CoRR, abs/1610.04286, 2016. URL http://arxiv.org/abs/1610.04286.
22. Fereshteh Sadeghi and Sergey Levine. (cad)$ˆ2$rl: Real single-image flight without a single real image. CoRR, abs/1611.04201, 2016. URL http://arxiv.org/abs/1611.04201.
23. Ahmad El Sallab, Mohammed Abdou, Etienne Perot, and Senthil Yogamani. End-to-end deep reinforcement learning for lane keeping assist. arXiv preprint arXiv:1612.04340, 2016.
24. John Schulman, Sergey Levine, Pieter Abbeel, Michael I Jordan, and Philipp Moritz. Trust region policy optimization. In ICML, pages 1889–1897, 2015. 
25. Shai Shalev-Shwartz, Shaked Shammah, and Amnon Shashua. Safe, multi-agent, reinforcement learning for autonomous driving. CoRR, abs/1610.03295, 2016. URL http://arxiv.org/abs/1610.03295.
26. Josh Tobin, Rachel Fong, Alex Ray, Jonas Schneider, Wojciech Zaremba, and Pieter Abbeel. Domain randomization for transferring deep neural networks from simulation to the real world. arXiv preprint arXiv:1703.06907, 2017.
27. Eric Tzeng, Coline Devin, Judy Hoffman, Chelsea Finn, Pieter Abbeel, Sergey Levine, Kate Saenko, and Trevor Darrell. Adapting deep visuomotor representations with weak pairwise constraints. In Workshop on the Algorithmic Foundations of Robotics (WAFR), 2016.
28. Xiaolong Wang and Abhinav Gupta. Generative image modeling using style and structure adversarial networks. In ECCV, 2016.
29. Jiajun Wu, Chengkai Zhang, Tianfan Xue, William T Freeman, and Joshua B Tenenbaum. Learning a probabilistic latent space of object shapes via 3d generativeadversarial modeling. In Advances in Neural Information Processing Systems, pages 82–90, 2016.
30. Bernhard Wymann, Eric Espié, Christophe Guionneau, Christos Dimitrakakis, Rémi Coulom, and Andrew Sumner. Torcs, the open racing car simulator. Software available at http://torcs.sourceforge.net, 2000.
31. Huazhe Xu, Yang Gao, Fisher Yu, and Trevor Darrell. End-to-end learning of driving models from large-scale video datasets. arXiv preprint arXiv:1612.01079, 2016.
32. Jiakai Zhang and Kyunghyun Cho. Query-efficient imitation learning for end-to-end autonomous driving. arXiv preprint arXiv:1605.06450, 2016.
